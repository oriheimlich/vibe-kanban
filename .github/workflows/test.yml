name: Test

on:
  pull_request:
    branches:
      - main
    paths-ignore:
      - .github/workflows/**
      - '!.github/workflows/test.yml'
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

env:
  CARGO_TERM_COLOR: always
  NODE_VERSION: 22
  PNPM_VERSION: 10.13.1
  RUST_TOOLCHAIN: nightly-2025-12-04
  RUNNER_LABEL: &runner_label blacksmith-16vcpu-ubuntu-2404

jobs:
  changes:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: read
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      backend: ${{ steps.filter.outputs.backend }}
      backend-remote: ${{ steps.filter.outputs['backend-remote'] }}
    steps:
      - uses: actions/checkout@v6
      - uses: dorny/paths-filter@0bc4621a3135347011ad047f9ecf449bf72ce2bd # v3.0.0
        id: filter
        with:
          filters: |
            frontend:
              - 'frontend/**'
              - 'shared/**'
              - 'scripts/check-i18n.sh'
              - 'pnpm-lock.yaml'
              - 'pnpm-workspace.yaml'
              - 'package.json'
              - '.npmrc'
              - '.github/workflows/test.yml'
              - '.github/actions/**'
            backend:
              - 'crates/api-types/**'
              - 'crates/db/**'
              - 'crates/deployment/**'
              - 'crates/executors/**'
              - 'crates/git/**'
              - 'crates/local-deployment/**'
              - 'crates/review/**'
              - 'crates/server/**'
              - 'crates/services/**'
              - 'crates/utils/**'
              - 'Cargo.toml'
              - 'Cargo.lock'
              - 'shared/**'
              - 'scripts/prepare-db.js'
              - 'pnpm-lock.yaml'
              - 'package.json'
              - 'rustfmt.toml'
              - 'rust-toolchain.toml'
              - '.cargo/**'
              - '.github/workflows/test.yml'
              - '.github/actions/**'
            backend-remote:
              - 'crates/remote/**'
              - 'crates/api-types/**'
              - 'crates/utils/**'
              - 'Cargo.toml'
              - 'Cargo.lock'
              - 'shared/**'
              - 'rust-toolchain.toml'
              - '.cargo/**'
              - 'pnpm-lock.yaml'
              - 'package.json'
              - '.github/workflows/test.yml'
              - '.github/actions/**'

  frontend-checks:
    needs: changes
    if: always() && (needs.changes.outputs.frontend == 'true' || needs.changes.result == 'skipped')
    runs-on: *runner_label
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node
        uses: ./.github/actions/setup-node

      - name: Install dependencies
        run: pnpm install

      - name: Run frontend checks
        env:
          NODE_OPTIONS: --max-old-space-size=8192
        run: |
          npx concurrently \
            --kill-others-on-fail \
            --names "lint,i18n,fmt,build" \
            --timings \
            "cd frontend && npm run lint" \
            "GITHUB_BASE_REF=${{ github.base_ref || 'main' }} ./scripts/check-i18n.sh" \
            "cd frontend && npm run format:check" \
            "cd frontend && npm run build"

  backend-schema-checks:
    needs: changes
    if: always() && (needs.changes.outputs.backend == 'true' || needs.changes.result == 'skipped')
    runs-on: *runner_label
    env:
      SCCACHE_GHA_ENABLED: "true"
      RUSTC_WRAPPER: "sccache"
    steps:
      - uses: actions/checkout@v6

      - name: Setup Rust
        uses: ./.github/actions/cargo-checks-common-setup
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}
          cache-key: backend-schema-checks-${{ runner.os }}-${{ runner.arch }}-${{ env.RUNNER_LABEL }}
          setup-node: 'true'
          setup-sqlx-cli: 'true'

      - name: Check generated types
        run: npm run generate-types:check

      - name: Sqlx checks
        run: npm run prepare-db:check

  backend-remote-checks:
    needs: changes
    if: >-
      always()
      && (needs.changes.outputs['backend-remote'] == 'true' || needs.changes.result == 'skipped')
      && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository)
    runs-on: *runner_label
    env:
      SCCACHE_GHA_ENABLED: "true"
      RUSTC_WRAPPER: "sccache"
    steps:
      - uses: actions/checkout@v6

      - name: Setup Rust
        uses: ./.github/actions/cargo-checks-common-setup
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}
          cache-key: backend-remote-checks-${{ runner.os }}-${{ runner.arch }}-${{ env.RUNNER_LABEL }}
          setup-node: 'true'
          setup-sqlx-cli: 'true'

      - name: Setup SSH Agent for private dependencies
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VK_PRIVATE_DEPLOY_KEY }}

      - name: Check remote Cargo.lock is consistent
        run: |
          cargo metadata --locked --format-version 1 --manifest-path crates/remote/Cargo.toml > /dev/null

      - name: Check generated types
        run: npm run remote:generate-types:check

      - name: Sqlx checks
        run: npm run remote:prepare-db:check

  backend-clippy:
    needs: changes
    if: always() && (needs.changes.outputs.backend == 'true' || needs.changes.result == 'skipped')
    runs-on: *runner_label
    env:
      SCCACHE_GHA_ENABLED: "true"
      RUSTC_WRAPPER: "sccache"
    steps:
      - uses: actions/checkout@v6

      - name: Setup Rust
        uses: ./.github/actions/cargo-checks-common-setup
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}
          components: rustfmt, clippy
          cache-key: backend-clippy-${{ runner.os }}-${{ runner.arch }}-${{ env.RUNNER_LABEL }}

      - name: Run Clippy and fmt checks
        run: |
          set -x
          cargo fmt --all -- --check & pid_fmt=$!
          cargo clippy --all --all-targets -- -D warnings
          wait $pid_fmt

  backend-test:
    needs: changes
    if: always() && (needs.changes.outputs.backend == 'true' || needs.changes.result == 'skipped')
    runs-on: *runner_label
    env:
      SCCACHE_GHA_ENABLED: "true"
      RUSTC_WRAPPER: "sccache"
    steps:
      - uses: actions/checkout@v6

      - name: Setup Rust
        uses: ./.github/actions/cargo-checks-common-setup
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}
          cache-key: backend-test-${{ runner.os }}-${{ runner.arch }}-${{ env.RUNNER_LABEL }}

      - name: Install cargo-nextest
        uses: taiki-e/install-action@nextest

      - name: Run Cargo tests
        run: cargo nextest run --workspace
